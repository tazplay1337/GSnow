<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($rootScope, $scope, spUtil) {
	var c = this;
/*
	if($scope.data.turn && false){
		$rootScope.$broadcast('INFO_UPDATE', $scope.data.mainInfo);		
		console.log("GS Main Root: " + $scope.data.mainInfo.display);
		console.log("GS Main Root: " + $scope.data.mainInfo.playeronturn);
	} */

	spUtil.recordWatch($scope, "x_166119_gsnow_game", "number=" + c.data.gameID, function(name, data) {
		if (!c.data.turn) {
			c.server.update().then(function(){
				c.data.mytext = $scope.data.mytext
				c.data.mainInfo.display = $scope.data.mainInfo.display;
				console.log("Main recordWatch text: " + c.data.mytext);
				console.log("Main recordWatch display: " + c.data.mainInfo.display);
			});
		}
	});

	$scope.drawCard = function() {
		console.log("drawCard: ");
		c.data.mainInfo.phase += 1;
		c.server.update().then(function(){
			if($scope.data.monsterCard.name != ""){
				$rootScope.monsterCard = $scope.data.monsterCard;
				console.log("drawCard monsterCard: " + $scope.data.monsterCard.name);
			}
			else if($scope.data.immediateCard.name != ""){
				$rootScope.immediateCard = $scope.data.immediateCard;
				console.log("drawCard immediateCard: " + $scope.data.immediateCard.name);
			}
			$rootScope.$broadcast('DRAW_CARD');
//			$rootScope.$broadcast('INFO_UPDATE', $scope.data.mainInfo);	
		});
	}
	
	$scope.fight = function(number) {
		alert("Attack");
		// Phase 3 gegen Monster kämpfen
	}
	
	$scope.runAway = function(number) {
		alert("runAway");
		// Phase 5 Zug beenden "Überspringe Kämpfen und Schatzkarten ziehen"
	}
	
	$scope.forward = function(number) {
		alert("forward");
		// Fallen Karte annehmen und zug is beendet
	}
	
	$scope.attack = function(number) {
		alert("Attack");
		// Gebe deine Antwort ab falls Lösung...
		// richtig dann gehe in phase 4 und bekomme deine belohnung
		// falsch dann gehe in phase 5 und bekomme die bestrafung
	}
	
	$scope.next = function(number) {
		alert("Attack");
		// beende deinen zug und der nächste spieler ist dran
	}

	$scope.showPhase = function(number) {
		if(c.data.mainInfo.phase == number && c.data.turn){
			return true;
		}
		else{
			return false;
		}
	}
	
	$scope.showIfMonster = function(number) {
		if(c.data.monsterCard.name != ""){
			return true;
		}
		else{
			return false;
		}
	}
	
	$scope.myTurn = function() {
		if(c.data.turn){
			return true;
		}
		else{
			return false;
		}
	}
}	





/*
	$scope.data.mainInfo = {
		"name": $rootScope.main.name,
		"phase":$rootScope.main.phase,
		"text": $rootScope.main.text
}
*/

/*
spUtil.recordWatch($scope, "x_166119_gsnow_monster", "u_name=Script Includer", function(name, data) {
		c.data.recordName = c.data.recordName + 1;
	});
*/]]></client_script>
        <controller_as>c</controller_as>
        <css>.panel-heading{
  width: 100%;
  height: 100px;
  text-align:center;
  p { font-size: 10pt;}
}

.panel {
  height: 500px;
  .each-pill {
    &amp;.active {
      color: #c70000;
    }
    height:100px;
    width:150px;
    background:#ddd;
    padding:25px;
    text-align:center;
    border-radius:4px;
    cursor:pointer;
  }
}

.color-red {
  color: #c70000;
}

.remove-margin {
  margin-bottom: 0px;
}

.main {
    margin-bottom: 20px;
  	height: 500px;
}
.questionsBox {
    background: #fff;
    display: block;
    border: solid 1px #e3e3e3;
    padding: 10px 20px 0px;
    box-shadow: inset 0 0 30px rgba(000,000,000,0.1), inset 0 0 4px rgba(255,255,255,1);
    border-radius: 3px;
    margin: 0 10px;
  	height: 100%;
  	max-height: 100%
}
.questions {
    background: #007fbe;
    color: #FFF;
    font-size: 22px;
    padding: 8px 30px;
  	text-align:center;
    margin: 0 -30px 10px;
    position: relative;
  	 p { font-size: 10pt;}
}
.questions:after {
    display: block;
    position: absolute;
    top: 100%;
    width: 9px;
    height: 7px;
    content: '.';
    left: 0;
    text-align: left;
    font-size: 0;
}
.questions:after {
    left: auto;
    right: 0;
    background-position: -10px 0;
}
.questions:before, .questions:after {
    background: black;
    display: block;
    position: absolute;
    top: 100%;
    width: 9px;
    height: 7px;
    content: '.';
    left: 0;
    text-align: left;
    font-size: 0;
}
.answerList {
    margin-bottom: 15px;
}


ol, ul {
    list-style: none;
}
.answerList li:first-child {
    border-top-width: 0;
}

.answerList li {
    padding: 3px 0;
}
.answerList label {
    display: block;
    padding: 6px;
    border-radius: 6px;
    border: solid 1px #dde7e8;
    font-weight: 400;
    font-size: 13px;
    cursor: pointer;
    font-family: Arial, sans-serif;
}
input[type=checkbox], input[type=radio] {
    margin: 4px 0 0;
    margin-top: 1px;
    line-height: normal;
}
.questionsRow {
    background: #dee3e6;
    margin: 0 -20px;
    padding: 10px 20px;
    border-radius: 0 0 3px 3px;
}
.button, .greyButton{
    background-color: #f2f2f2;
    color: #888888;
    display: inline-block;
    border: solid 3px #cccccc;
    text-shadow: 0 1px 0 #ffffff;
    line-height: 27px;
    min-width: 160px;
    text-align: center;
    padding: 5px 20px;
    text-decoration: none;
    border-radius: 0px;
    text-transform: capitalize;
}
.questionsRow span {
    float: right;
    display: inline-block;
    line-height: 30px;
    border: solid 1px #aeb9c0;
    padding: 0 10px;
    background: #FFF;
    color: #007fbe;
}

</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>gs_main</id>
        <internal>false</internal>
        <link/>
        <name>GS Main</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function(){
	data.turn = false;
	data.mytext = "Wait Until Its Your Turn";
	data.mainInfo = {
		"playeronturn": "",
		"phase": 0,
		"doorcards": 0,
		"treasure_cards": 0,
		"text": "",
		"display": "",
		"displayToMe": "It's your turn!"
	}

	data.immediateCard = {
		"name": "",
		"cardtype": "",
		"image": "",
		"short_description": "",
		"effect": "",
		"lifetime": ""
	}
	data.monsterCard = {
		"name": "",
		"image": "",
		"level": "",
		"cardtype": "",
		"reward_treasure": "",
		"reward_level": "",
		"short_description": ""
	}

	// Get current Game
	data.gameID = $sp.getParameter("gameID");
	var grGame = new GlideRecord('x_166119_gsnow_game');
	grGame.get('number', data.gameID);
	data.mainInfo.doorcards = grGame.u_number_door_cards.getDisplayValue();

	// Get my settings for this round
	var grPlayer = new GlideRecord('x_166119_gsnow_player');
	grPlayer.addQuery('u_game.number', data.gameID);
	grPlayer.addQuery('u_user', gs.getUserID());
	grPlayer.query();

	if(grPlayer.next() && grGame.u_turn == grPlayer.u_number){
		data.turn = true;
		data.mainInfo.playeronturn = grPlayer.u_user.getDisplayValue();
	}
	
	// Set Phase
	if(input && data.turn){
		data.mainInfo.phase = input.mainInfo.phase;
		grGame.u_phase = data.mainInfo.phase;
		grGame.update();
		gs.addInfoMessage("1: Get Phase 1: " + data.mainInfo.phase);
	}
	else if(!input && data.turn){
		grGame.u_phase = 0;
		grGame.update();
		data.mainInfo.phase = 0;
		gs.addInfoMessage("1: Get Phase 2: " + data.mainInfo.phase);
	}
	else if(input && !data.turn){
		data.mainInfo.phase = grGame.u_phase.getDisplayValue();
		gs.addInfoMessage("1: Get Phase 3: " + data.mainInfo.phase);
	}
	else{
		data.mainInfo.phase = grGame.u_phase.getDisplayValue();
		gs.addInfoMessage("1: Get Phase 4: " + data.mainInfo.phase);
	}
	
	// Set Default
	data.mainInfo.display = "Player " + grGame.u_turn.getDisplayValue() + " is on the move and is now drawing a doorcard.";
	
	// Phase ZERO
	if(data.turn && data.mainInfo.phase == 0){
		data.mainInfo.display = "Click to draw a doorcard if you are ready!";
		data.mytext = "Draw a Doorcard!"
	} 
	// Phase ONE
	else if(data.turn && data.mainInfo.phase == 1){
		gs.addInfoMessage("3: Phase 1 ");
		
		var grDeck2 = new GlideRecord('x_166119_gsnow_m2m_cards_games');
		grDeck2.addQuery('game', grGame.sys_id);
		grDeck2.addQuery('u_deck', 'true');
		grDeck2.addQuery('card.u_deck_type', '20');
		grDeck2.orderBy('u_card_number');
		grDeck2.chooseWindow(0, 1);
		grDeck2.query();
		
		grGame.u_number_door_cards -= 1;
		grGame.update();

		if(grDeck2.next()){
			grDeck2.u_deck = false;
			grDeck2.update();

			if(grDeck2.card.u_card_type.getDisplayValue() == 'Monster' ){
				data.mytext= "FIGHT";
				gs.addInfoMessage("Debug 2: " + grDeck2.card.u_name.getDisplayValue());
				var imageID ='';
				var grImage = new GlideRecord('sys_attachment');
				grImage.addQuery('file_name','u_image');
				grImage.addQuery('table_sys_id',grDeck2.card.sys_id.getDisplayValue());
				grImage.query();

				while(grImage.next()){
					imageID = grImage.sys_id.getDisplayValue();
				}

				data.monsterCard = {
					"name": grDeck2.card.u_name.getDisplayValue(),
					"image": imageID,
					"level": grDeck2.card.u_level.getDisplayValue(),
					"cardtype": grDeck2.card.u_card_type.getDisplayValue(),
					"reward_treasure": grDeck2.card.u_reward_treasure.getDisplayValue(),
					"reward_level": grDeck2.card.u_reward_level.getDisplayValue(),
					"short_description": grDeck2.card.u_short_description.getDisplayValue()
				}
				data.mainInfo.display = "fighting! vs " + data.monsterCard.name;
				data.mainInfo.displayToMe = "You have to fight this monster!";
			}
			else{
				data.immediateCard = {
					"name": grDeck2.card.u_name.getDisplayValue(),
					"cardtype": grDeck2.card.u_card_type.getDisplayValue(),
					"image": "https://www.wikihow.com/images/thumb/c/cf/Cast-a-Spell-Step-11-Version-2.jpg/aid1057820-v4-728px-Cast-a-Spell-Step-11-Version-2.jpg",
					"short_description": grDeck2.card.u_short_description.getDisplayValue(),
					"effect": grDeck2.card.u_effect.getDisplayValue(),
					"lifetime": grDeck2.card.u_lifetime.getDisplayValue()
				}
				data.mainInfo.display = data.mainInfo.playeronturn + " draw a immediate card " + data.immediateCard.name;
				data.mainInfo.displayToMe = "This " + grDeck2.card.u_card_type.getDisplayValue() + " effects you!"; 
			}
		}
		grGame.u_main_text = data.mainInfo.display;
		grGame.update();
	}
	// PHASE TWO
	else if(data.turn && data.mainInfo.phase == 2){
		gs.addInfoMessage("PHASE 2");
		data.mainInfo.text = "WTF IS PHASE 2";
		data.mainInfo.displayToMe = "WAAUW PHASE 2";
		grGame.u_main_text = "WAAUW PHASE 2";
		grGame.update();	
	}
	// PHASE WAIT
	else if(!data.turn && data.mainInfo.phase > 0){
		gs.addInfoMessage("4: Else  " + data.turn );
		data.mainInfo.display = grGame.u_main_text.getDisplayValue();
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-01-03 17:01:28</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>c1364af74fd303009827c4b18110c779</sys_id>
        <sys_mod_count>369</sys_mod_count>
        <sys_name>GS Main</sys_name>
        <sys_package display_value="GSnow" source="x_166119_gsnow">1f4727414f3203009827c4b18110c713</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="GSnow">1f4727414f3203009827c4b18110c713</sys_scope>
        <sys_update_name>sp_widget_c1364af74fd303009827c4b18110c779</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-01-09 22:40:00</sys_updated_on>
        <template><![CDATA[<div class="main">
  <div class="questionsBox">

    <div class="questions">
      <h3>{{c.data.mytext}}</h3>
      <p ng-if="!myTurn()">{{c.data.mainInfo.display}}</p>
      <p ng-if="myTurn()">{{c.data.mainInfo.displayToMe}}</p>
    </div>
    
    <div class="questionsRow" ng-if="showPhase(0)" ng-click="">
        <a class="button" ng-click="drawCard()">Draw</a><span>{{c.data.mainInfo.doorcards}} Doorcards Left</span>
    </div>
    
    <div class="questionsRow" ng-if="showPhase(1)" ng-click="">
        <a class="button" ng-if="showIfMonster()" ng-click="fight()">Fight</a> <a class="button" ng-if="showIfMonster()" ng-click="runAway()">Run Away</a><a class="button" ng-if="!showIfMonster()" ng-click="forward()">Forward</a> 
    </div>

    
    <div ng-if="show(2)">
      <div>
        <ul class="answerList">
          <li>
            <label> <input type="radio"> It specifies static for a backdrop, if you don't want the modal to be closed when the user clicks outside of the modal.</label>
          </li>
          <li>
            <label> <input type="radio"> It closes the modal when escape key is pressed; set to false to disable.</label>
          </li>
          <li>
            <label> <input type="radio"> It shows the modal when initialized.</label>
          </li>
          <li>
            <label>
              <input type="radio"> Using the jQuery .load method, injects content into the modal body. If an href with a valid URL is added, it will load that content.</label>
          </li>
        </ul>
      </div>
      <div class="questionsRow" ng-click="">
        <a class="button" ng-click="attack()">Attack!</a>
      </div>
    </div>
  </div>
</div>


<!--
<div class="panel panel-primary">
<div class="panel-heading">
<div>
<h3>{{c.data.mytext}}</h3>
<p ng-if="!myTurn()">{{c.data.mainInfo.display}}</p>
<p ng-if="myTurn()">{{c.data.mainInfo.displayToMe}}</p>
</div>
</div>
<div class="panel-body">
<div class="each-pill" ng-class="{'active':c.selectedPill == 'requests'}" ng-if="show(0)" ng-click="drawCard()">
<i class="fa fa-eye fa-2x"></i>
<p class="remove-margin">{{data.mytext}}</p>
</div>
</div>
</div>
-->




<!--
<div class=" pill-background row">
<div class="jumbotron jumbotron-fluid">
<div class="container">
<h1 class="display-4">Fluid jumbotron</h1>
<p class="lead">This is a modified jumbotron that occupies the entire horizontal space of its parent.</p>
</div>
<div> 
<div class="each-pill" ng-class="{'active':c.selectedPill == 'requests'}" ng-if="show(0)" ng-click="drawCard()">
<i class="fa fa-eye fa-2x"></i>
<p class="remove-margin">{{data.mytext}}</p>
</div>
</div>
</div>
</div>

<div class="panel panel-primary">
<div class="page-header">
<div>
<h2>Fluid jumbotron</h2>
<p class="lead">This is a modified jumbotron that occupies the entire horizontal space of its parent.</p>
</div>
</div>
<div class="panel-body">
<div class="each-pill" ng-class="{'active':c.selectedPill == 'requests'}" ng-if="show(0)" ng-click="drawCard()">
<i class="fa fa-eye fa-2x"></i>
<p class="remove-margin">{{data.mytext}}</p>
</div>
</div>
</div>


<div class="each-pill" ng-class="{'active':c.selectedPill == 'requests'}" ng-if="show(1)" ng-click="">
<i class="fa fa-eye fa-3x"></i>
<p class="remove-margin">{{data.mytext}}</p>
</div>
<div class="each-pill" ng-class="{'active':c.selectedPill == 'requests'}" ng-if="show(1)" ng-click="">
<i class="fa fa-eye fa-3x"></i>
<p class="remove-margin">{{data.mytext}}</p>
</div>

<div class="each-pill" ng-class="{'active':c.selectedPill == 'create'}" ng-click="selectPill('create')">
<i class="fa fa-2x fa-wrench " aria-hidden="true"></i>
<p class="remove-margin">Create Request</p>
</div>

<div class="each-pill" ng-class="{'active':c.selectedPill == 'contact'}" ng-click="selectPill('contact')">
<i class="fa fa-2x fa-phone "  aria-hidden="true"></i>
<p class="remove-margin">Contact</p>
</div>

</div>
</div>
-->


<!--
<div class="container">
<div class="h3">{{data.header}}</div>
<div>
<div ng-if="show(0)">
<button type="button" class="btn btn-default ribbon" ng-click="drawCard()">Draw</button>
</div>
</div>
</div>
-->















<!--
<form class="form-horizontal">
<fieldset ng-if=c.data.turn>
<legend class="h3" align="center">{{data.header}}</legend>
<div class="form-group">
<label for="checkbox">{{data.monster.question}}</label>
<div id="checkbox">
<input type="checkbox" name="checkboxes" id="checkboxes-0" value="1">{{data.monster.answera}}<br>
<input type="checkbox" name="checkboxes" id="checkboxes-1" value="2">{{data.monster.answerb}}<br>
<input type="checkbox" name="checkboxes" id="checkboxes-2" value="3">{{data.monster.answerc}}<br>
<input type="checkbox" name="checkboxes" id="checkboxes-3" value="4">{{data.monster.answerd}}<br>
<input type="checkbox" name="checkboxes" id="checkboxes-4" value="5">{{data.monster.answere}}<br>
</div>
<br/>
<div id="button">
<button id="singlebutton" name="singlebutton" class="btn btn-success">Attack</button>
</div>
</div>
</fieldset>
</form>
-->













<!--
<div id="background">
<div id="timer">
10:32
</div>
<div id="image">
<div class="img" style="background-image:url({{window.location.origin}}/sys_attachment.do?sys_id={{data.monster.image}}" ng-if="data.monster.image"></div>
</div>
<div id="short_description">
<p>{{data.monster.question}}</p>
<form>
<input type="checkbox" name="answera" value="a" >{{data.monster.answera}}<br>
<input type="checkbox" name="answera" value="a">{{data.monster.answerb}}<br>
<input type="checkbox" name="answera" value="a">{{data.monster.answerc}}<br>
<input type="checkbox" name="answera" value="a">{{data.monster.answerd}}<br>
<input type="checkbox" name="answera" value="a" ng-show="{{data.monster.answere}}">{{data.monster.answere}}<br>
<br>
<input type="submit" value="Answer">
</form>
</div>
</div>
-->]]></template>
    </sp_widget>
</record_update>
